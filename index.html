<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MapLibre Reverse Geocoder</title>
  <link href="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    #map { width: 100%; height: 500px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    // Initialize the map
    const map = new maplibregl.Map({
      style: 'https://tiles.openfreemap.org/styles/liberty',
      center: [13.388, 52.517], // Berlin
      zoom: 9.5,
      container: 'map',
    });

    let cities = [];

    // Load your cities.json (make sure it's served by your web server in the same folder)
    fetch('https://s3.tripgeo.com/cities.json')
      .then(res => res.json())
      .then(data => {
        cities = data;
        console.log("Loaded cities:", cities.length);
      });

    // Haversine formula for distance
    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371; // km
      const toRad = x => x * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Find nearest city
    function findNearestCity(lat, lng) {
      let nearest = null;
      let minDist = Infinity;

      for (const city of cities) {
        const dist = haversine(lat, lng, city.lat, city.lng);
        if (dist < minDist) {
          minDist = dist;
          nearest = city;
        }
      }

      return nearest;
    }

    // Add click handler
    map.on('click', (e) => {
      const { lng, lat } = e.lngLat;
      const city = findNearestCity(lat, lng);

      if (city) {
        new maplibregl.Popup()
          .setLngLat([city.lng, city.lat])
          .setHTML(`<b>${city.name}</b><br>Population: ${city.pop.toLocaleString()}`)
          .addTo(map);
      } else {
        alert("No city data loaded.");
      }
    });
  </script>
</body>
</html>
